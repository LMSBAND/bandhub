rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: is the user an active (non-pending) member of the band?
    function isActiveMember(bandId) {
      let member = get(/databases/$(database)/documents/bands/$(bandId)).data.members[request.auth.uid];
      return member != null && (member.role == "admin" || member.role == "member");
    }

    function isAdmin(bandId) {
      let member = get(/databases/$(database)/documents/bands/$(bandId)).data.members[request.auth.uid];
      return member != null && member.role == "admin";
    }

    // Band documents
    match /bands/{bandId} {
      // Any authenticated user can read bands (needed to look up invite codes)
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Members can update, OR a new user can join via invite code
      allow update: if request.auth != null
                    && (request.auth.uid in resource.data.members
                        || resource.data.inviteCode != null);

      // Media subcollection - active members only
      match /media/{mediaId} {
        allow read, write: if request.auth != null && isActiveMember(bandId);

        // Comments on media
        match /comments/{commentId} {
          allow read, write: if request.auth != null && isActiveMember(bandId);

          // Replies on comments
          match /replies/{replyId} {
            allow read, write: if request.auth != null && isActiveMember(bandId);
          }
        }
      }

      // Events subcollection - active members only
      match /events/{eventId} {
        allow read, write: if request.auth != null && isActiveMember(bandId);
      }

      // Chat channels - active members only
      match /channels/{channelId} {
        allow read, write: if request.auth != null && isActiveMember(bandId);

        match /messages/{messageId} {
          allow read, write: if request.auth != null && isActiveMember(bandId);
        }
      }
    }
  }
}
